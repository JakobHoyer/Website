<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risk – Hold & Lande Fordeler</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 16px;line-height:1.4}
    h1{margin:0 0 8px} .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    textarea,input,button,select{font:inherit} textarea,input,select{width:100%;box-sizing:border-box}
    textarea{min-height:140px} .grid{display:grid;gap:12px}
    @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    .muted{color:#555;font-size:0.9rem} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border-radius:999px;padding:2px 8px;margin:2px;display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e5e5;background:#f8f8f8}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #0001}
    .small{font-size:.9rem} .danger{color:#b00020}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <h1>Risk – Hold & Lande Fordeler</h1>
  <p class="muted">Vælg variant (Classic/Transformers/…) – samme <i>seed</i> giver samme resultat. Skriv evt. <span class="mono">Navn (farve)</span> pr. linje.</p>

  <div class="grid grid-2">
    <section class="card">
      <h2>Input</h2>

      <label>Variant</label>
      <div class="row">
        <select id="variant"></select>
        <input id="newVariantName" placeholder="Ny variant-navn (valgfrit)" />
        <button id="createVariant">Opret tom variant</button>
        <button id="deleteVariant" title="Slet den valgte variant">Slet variant</button>
      </div>

      <label style="margin-top:8px;">Spillere (én per linje)</label>
      <textarea id="players">Alice
Bob
Charlie
Dana</textarea>

      <div class="grid" style="grid-template-columns:1fr 1fr;">
        <div>
          <label>Antal hold</label>
          <input id="teams" type="number" min="1" value="2" />
        </div>
        <div>
          <label>Seed</label>
          <input id="seed" type="text" value="default-seed" />
        </div>
      </div>

      <label class="row" style="margin-top:8px;">
        <input id="assignToPlayers" type="checkbox" />
        <span class="small">Tildel lande til <b>spillere</b> (ellers får holdene en samlet liste)</span>
      </label>

      <details style="margin-top:8px;" open>
        <summary>Lande-liste for varianten (ét navn pr. linje, evt. <span class="mono">(farve)</span>)</summary>
        <textarea id="territories"></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="saveVariantList">Gem til varianten</button>
          <span class="small muted">Gemmes i din browser (localStorage). Format: <span class="mono">Navn</span> eller <span class="mono">Navn (rød)</span>.</span>
        </div>
      </details>

      <div class="row" style="margin-top:12px;">
        <button id="go">Fordel</button>
        <button id="copy">Kopiér resultat</button>
        <span id="err" class="danger small"></span>
      </div>
    </section>

    <section class="card">
      <h2>Resultat</h2>
      <div id="result" class="small">—</div>
    </section>
  </div>

<script>
  // ---------- Farvemapping (danske ord -> CSS) ----------
  const COLOR_MAP = {
    "rød":"red","roed":"red","rødt":"red",
    "blå":"blue","blaa":"blue","blåt":"blue",
    "grøn":"green","groen":"green","grønt":"green",
    "gul":"gold","gult":"gold",
    "lilla":"purple",
    "orange":"orange",
  };
  function toCssColor(label){ if(!label) return null; const k = label.trim().toLowerCase(); return COLOR_MAP[k] || null; }

  // ---------- Classic Risk m. kontinent-farver (kan justeres) ----------
  // Farverne her er "hjælpe-farver" pr. kontinent for nem visning. Ret frit hvis din plade bruger andre.
  const CLASSIC = {
    // Nordamerika (blå)
    "Alaska":"blå","Northwest Territory":"blå","Greenland":"blå","Alberta":"blå","Ontario":"blå","Quebec":"blå","Western United States":"blå","Eastern United States":"blå","Central America":"blå",
    // Sydamerika (orange)
    "Venezuela":"orange","Peru":"orange","Brazil":"orange","Argentina":"orange",
    // Europa (grøn)
    "Iceland":"grøn","Great Britain":"grøn","Scandinavia":"grøn","Northern Europe":"grøn","Western Europe":"grøn","Southern Europe":"grøn","Ukraine":"grøn",
    // Afrika (gul)
    "North Africa":"gul","Egypt":"gul","East Africa":"gul","Congo":"gul","South Africa":"gul","Madagascar":"gul",
    // Asien (rød)
    "Ural":"rød","Siberia":"rød","Yakutsk":"rød","Kamchatka":"rød","Irkutsk":"rød","Mongolia":"rød","Japan":"rød","Afghanistan":"rød","China":"rød","Middle East":"rød","India":"rød","Siam":"rød",
    // Australien (lilla)
    "Indonesia":"lilla","New Guinea":"lilla","Western Australia":"lilla","Eastern Australia":"lilla",
  };

  // ---------- Transformers Risk fra dig ----------
  const TRANSFORMERS_LIST = [
    "Autobase (rødt)","Tyrest (rødt)","Decagon (rødt)","Tagon-Højderne (rødt)","De Neutrale Territorier (rødt)","Plasma-energikammere (rødt)",
    "Betaplatform i Kredsløb (blå)","Vos (blå)","Affyringsrampe (blå)","Hexima-staten (blå)","Arenaen (blå)","Rad-zonen (blå)","Tarn (blå)","Stella Galleries (blå)","Praetorus-Lossebroen (blå)",
    "Oldtidens Kammer (grøn)","Centrum (grøn)","Nova Cronum (grøn)","Tyger Pax (grøn)","Storråds-pavillonerne (grøn)","Unicron (grøn)","Pion-tårnet (grøn)","Uraya (grøn)","Primus (grøn)","Iacon (grøn)","Oraklet (grøn)","Protihex (grøn)",
    "Grænseområderne (gul)","Perihex (gul)","Kalis (gul)","Rumbroen (gul)",
    "Polyhex (lilla)","Praxus (lilla)","Smeltediglen (lilla)","Altihex (lilla)","Kaon (lilla)","Kolkular (lilla)","Maccadams (lilla)",
    "Tritorus (orange)","Sonic-floddalen (orange)","Hydrax-højsletten (orange)","Alpha-månen (orange)"
  ];

  // ---------- Variant storage (localStorage) ----------
  // Intern format: { [variantName]: Array<{name:string,color?:string}> }
  const LS_KEY = "risk_variants_v2";

  function parseLine(line){
    // "Navn (farve)" eller bare "Navn"
    const m = line.match(/^(.+?)(?:\s*\((.+?)\)\s*)?$/);
    if(!m) return null;
    const name = m[1].trim();
    const color = m[2]?.trim() || null;
    return name ? { name, color } : null;
  }

  function parseTextareaToItems(text){
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(parseLine).filter(Boolean);
  }

  function itemsToTextarea(items){
    return items.map(it => it.color ? `${it.name} (${it.color})` : it.name).join("\n");
  }

  function loadVariants(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try {
        const obj = JSON.parse(raw);
        // Backcompat: strings -> objects
        for(const k of Object.keys(obj)){
          obj[k] = (obj[k] || []).map(v => typeof v === "string" ? parseLine(v) : v).filter(Boolean);
        }
        return obj;
      } catch {}
    }
    // Førstegangsload: læg Classic + Transformers ind
    const classicItems = Object.keys(CLASSIC).map(name => ({ name, color: CLASSIC[name] }));
    const transformersItems = TRANSFORMERS_LIST.map(parseLine).filter(Boolean);
    const base = { "Classic (42)": classicItems, "Transformers": transformersItems };
    localStorage.setItem(LS_KEY, JSON.stringify(base));
    return base;
  }
  function saveVariants(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

  let variants = loadVariants();

  // ---------- RNG & utils ----------
  function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=(h<<13)|(h>>>19);}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^=h>>>16)>>>0;}}
  function mulberry32(a){return function(){let t=a+=0x6d2b79f5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;};}
  function shuffle(arr, seedStr){
    const seed = xmur3(seedStr)(); const rand = mulberry32(seed);
    const a = arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;
  }
  function chunkRoundRobin(items, buckets){
    const res = Array.from({length:buckets},()=>[]);
    items.forEach((it,i)=>res[i%buckets].push(it));
    return res;
  }

  // ---------- DOM ----------
  const $ = id => document.getElementById(id);
  const playersEl = $('players'), teamsEl = $('teams'), seedEl = $('seed');
  const terrEl = $('territories'), assignToPlayersEl = $('assignToPlayers');
  const resultEl = $('result'), errEl = $('err');
  const variantSel = $('variant'), newVariantNameEl = $('newVariantName');

  function refreshVariantSelect(selected){
    variantSel.innerHTML = '';
    Object.keys(variants).forEach(name=>{
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
      if(name===selected) opt.selected = true;
      variantSel.appendChild(opt);
    });
  }
  function loadVariantToTextarea(name){
    terrEl.value = itemsToTextarea(variants[name] || []);
  }

  // init UI
  refreshVariantSelect(Object.keys(variants)[0]);
  loadVariantToTextarea(variantSel.value);

  variantSel.onchange = ()=> loadVariantToTextarea(variantSel.value);

  $('createVariant').onclick = ()=>{
    const name = (newVariantNameEl.value||'Ny variant').trim();
    if(!name){ alert('Giv varianten et navn.'); return; }
    if(variants[name]){ alert('Den variant findes allerede.'); return; }
    variants[name] = [];
    saveVariants(variants);
    refreshVariantSelect(name);
    loadVariantToTextarea(name);
    newVariantNameEl.value = '';
  };

  $('deleteVariant').onclick = ()=>{
    const name = variantSel.value;
    if(name.startsWith('Classic')) { alert('Du kan ikke slette Classic-varianten.'); return; }
    if(!confirm(`Slet varianten "${name}"?`)) return;
    delete variants[name];
    saveVariants(variants);
    const first = Object.keys(variants)[0];
    refreshVariantSelect(first);
    loadVariantToTextarea(first);
  };

  $('saveVariantList').onclick = ()=>{
    const name = variantSel.value;
    variants[name] = parseTextareaToItems(terrEl.value);
    saveVariants(variants);
    alert(`Gemte ${variants[name].length} territorier til varianten "${name}".`);
  };

  function formatTerritory(it){
    const css = toCssColor(it.color);
    const dot = css ? `<span class="dot" style="background:${css}"></span>` : `<span class="dot" style="background:#ddd"></span>`;
    return `${dot}<span>${it.name}</span>`;
  }

  $('go').onclick = () => {
    errEl.textContent = '';
    const players = playersEl.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const teamsCount = Math.max(1, parseInt(teamsEl.value||'1',10));
    const seed = seedEl.value || 'seed';
    const items = parseTextareaToItems(terrEl.value);
    const assignToPlayers = assignToPlayersEl.checked;

    if(players.length < teamsCount){ errEl.textContent = 'Antal hold må ikke være større end antal spillere.'; return; }
    if(items.length === 0){ errEl.textContent = 'Ingen territorier i denne variant.'; return; }

    const shuffledPlayers = shuffle(players, seed+'::p');
    const teams = chunkRoundRobin(shuffledPlayers, teamsCount);
    const shuffledTerr = shuffle(items, seed+'::t');

    let html = '';
    teams.forEach((team, i)=>{
      html += `<div class="card"><b>Hold ${i+1}</b><br/>Spillere: ${team.map(p=>`<span class="pill">${p}</span>`).join(' ')}<br/>`;
      if(assignToPlayers){
        const perPlayer = new Map(team.map(p=>[p,[]]));
        shuffledTerr.forEach((t,idx)=>{ const p = shuffledPlayers[idx % shuffledPlayers.length]; if(perPlayer.has(p)) perPlayer.get(p).push(t); });
        html += `<div style="margin-top:6px;">`;
        team.forEach(p=>{
          const list = (perPlayer.get(p)||[]).map(it=>`<span class="pill">${formatTerritory(it)}</span>`).join(' ') || '—';
          html += `<div><b>${p}:</b> ${list}</div>`;
        });
        html += `</div>`;
      } else {
        const teamBuckets = chunkRoundRobin(shuffledTerr, teamsCount);
        const list = (teamBuckets[i]||[]).map(it=>`<span class="pill">${formatTerritory(it)}</span>`).join(' ') || '—';
        html += `<div style="margin-top:6px;"><b>Start-lande (hold):</b> ${list}</div>`;
      }
      html += `</div>`;
    });
    resultEl.innerHTML = html || '—';
  };

  $('copy').onclick = async () => {
    const text = resultEl.textContent || '';
    try { await navigator.clipboard.writeText(text); alert('Resultat kopieret.'); }
    catch { alert('Kunne ikke kopiere – marker og kopier manuelt.'); }
  };
</script>
</body>
</html>
